<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8" />
	<meta name="author" content="≈Ωan ≈Ωnidar">
	<title>Upevanje</title>
	<meta name="description" content="Samodejni sintetizator spremljave pri upevanju">
	<!-- polyfill -->
	<script src="drugoImeMape/inc/shim/Base64binary.js"></script>
	<script src="drugoImeMape/inc/shim/Base64.js"></script>
	<script src="drugoImeMape/inc/shim/WebAudioAPI.js"></script>
	<!-- midi.js package -->
	<script src="drugoImeMape/js/midi/audioDetect.js"></script>
	<script src="drugoImeMape/js/midi/gm.js"></script>
	<script src="drugoImeMape/js/midi/loader.js"></script>
	<script src="drugoImeMape/js/midi/plugin.audiotag.js"></script>
	<script src="drugoImeMape/js/midi/plugin.webaudio.js"></script>
	<script src="drugoImeMape/js/midi/plugin.webmidi.js"></script>
	<!-- utils -->
	<script src="drugoImeMape/js/util/dom_request_xhr.js"></script>
	<script src="drugoImeMape/js/util/dom_request_script.js"></script>
</head>
<body>

	<textarea id="inStopnje" name="inStopnje" rows="1" cols="50" placeholder="Lestviƒçne stopnje vokalne vaje, loƒçene s predledkom, npr. 1 3 5 5 4 3 2 1"></textarea> 
	<br>
	<textarea id="inDobe" name="inDobe" rows="1" cols="50" placeholder="Trajanje stopenj vokalne vaje, loƒçeno s predledkom, npr. 1 1 1 1 2 1 1 1"></textarea> 
	<br>
	<label for="inTempo">Tempo [bpm]: </label>
	<input type="number" name="inTempo" id="inTempo" min="1" value="160">
	<br>
	<label for="inZacetnaNota">Zaƒçetni ton (C4 = Middle C = enoƒçrtana oktava): </label>
	<input type="text" name="inZacetnaNota" id="inZacetnaNota" value="A2">
	<br>
	<label for="inPostop">Postop (≈°t. poltonov) med iteracijami: </label>
	<input type="number" name="inPostop" id="inPostop" value="1">
	<input type="button" value="Obrni üîÑ" onclick="obrni()">
	<br>
	<label for="inKoncnaNota">Zadnji ≈°e dovoljeni ton (Eb2 = zni≈æan E): </label>
	<input type="text" name="inKoncnaNota" id="inKoncnaNota" value="D4">
	<input type="button" value="Play" onclick="play()" />
	<!-- <input type="button" value="Stop" onclick="MIDI.stopAllNotes()" /> -->
	<br>
	<br>
	<textarea id="inVokali" name="inVokali" rows="1" cols="50" placeholder="Vokali/besedilo (za osebno evidenco)"></textarea>

<script>
// MIDI.js: https://github.com/mudcube/MIDI.js
window.onload = function () {
	MIDI.loadPlugin({
		soundfontUrl: "drugoImeMape/soundfont/",
		instrument: "acoustic_grand_piano",
		onprogress: function(state, progress) {
			//alert(state + progress);
		},
		onsuccess: function() {
			var delay = 0; // play one note every quarter second
			var note = 50; // the MIDI note
			var velocity = 127; // how hard the note hits
			// play the note
			MIDI.setVolume(0, 127);
			//MIDI.noteOn(0, note, velocity, delay);
			//MIDI.noteOff(0, note, delay + 0.75);
		}
	});
};

</script>
<script>
	function stopnje2note(stopnje, lestvica=[0, 0, 2, 4, 5, 7, 9, 11]) {
		// 0th element of lestvica is redundant; it should never be accessed
		// Stopnje skip 0, like this: 3 2 1 -1 -2 -3
		const OKTAVA = 12;
		let note = [];
		for (s of stopnje) {
			let dodatek = s>>3; // How many octaves to add
			s = s%8;

			note.push(lestvica.at(s) + dodatek*OKTAVA);
		}
		return note;
	}





	tempo = 120; // bpm
	bps = tempo/60; // beats per second

	function play(){
		stopnje = document.getElementById("inStopnje").value.split(" ").map(Number);
		dobe = document.getElementById("inDobe").value.split(" ").map(Number);
		tempo = parseInt(document.getElementById("inTempo").value);
		bps = tempo/60; // beats per second
		zacetnaNota = MIDI.keyToNote[document.getElementById("inZacetnaNota").value];
		postop = parseInt(document.getElementById("inPostop").value);
		koncnaNota = MIDI.keyToNote[document.getElementById("inKoncnaNota").value];
		
		note = stopnje2note(stopnje);
		console.log(note, note.length);

		var delay = 0; // play one note every quarter second
		var velocity = 127; // how hard the note hits
		// play the note
		MIDI.setVolume(0, 127);
		
		starter = zacetnaNota;
		stopper = postop > 0 ? (koncnaNota - Math.max(...stopnje) - 1) : (koncnaNota - Math.min(...stopnje));
		
		console.log(starter, stopper, postop);
		
		while((starter < stopper && postop > 0) || (starter > stopper && postop < 0)) {
			MIDI.noteOn(0, note[0]+starter, velocity, delay);
			MIDI.noteOff(0, note[0]+starter, delay + 2/bps);
			delay += 2/bps;
			for (let i = 0; i < note.length; i++) {
				console.log(note[i]+starter);
				trajanje = dobe?.[i] || 1;
				MIDI.noteOn(0, note[i]+starter, velocity, delay);
				MIDI.noteOff(0, note[i]+starter, delay + trajanje/bps);
				delay += trajanje/bps;
			}
			starter += postop;
		}
		//MIDI.noteOn(0, note, velocity, delay);
		//MIDI.noteOff(0, note, delay + 0.75);
	}

	function obrni() {
		let tmp = document.getElementById("inZacetnaNota").value;
		document.getElementById("inZacetnaNota").value = document.getElementById("inKoncnaNota").value;
		document.getElementById("inKoncnaNota").value = tmp;
		document.getElementById("inPostop").value = -parseInt(document.getElementById("inPostop").value);
	}
</script>
</body>
</html>